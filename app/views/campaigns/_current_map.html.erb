<% if campaign.current_map.present? %>
  <%= content_tag :h2, campaign.current_map.name %>
  <%= content_tag :div,
    data: {
      controller: "map",
      "map-id": campaign.current_map.id,
    } do %>
    <div class="flex flex-row">
      <% if dm?(campaign) %>
        <div class="current-map__token-drawer token-drawer" data-target="map.tokenDrawer" data-action="dragover->map#dragOverDrawer drop->map#dropOnDrawer">
          <% if dm?(campaign) %>
            <%= link_to new_map_token_path(campaign.current_map), remote: true, title: "New Token", class: "token new-token-link" do %>
              <span class="token__image token__image-add">+</span>
            <% end %>
          <% end %>

          <%= render campaign.current_map.tokens.where(stashed: true) %>
        </div>
      <% end %>
      <%= content_tag :div,
        class: "current-map relative overflow-hidden",
        data: {
          controller: "css-var",
          "map-id": campaign.current_map.id,
          target: "map.image",
          action: "dragover->map#dragOverMap drop->map#dropOnMap mousedown->map#pointTo #{dm?(campaign, "mousedown->map#moveMap")}",
          x: campaign.current_map.x,
          y: campaign.current_map.y,
          zoom: campaign.current_map.zoom,
          "zoom-amount": campaign.current_map.zoom_amount,
          height: campaign.current_map.height,
          width: campaign.current_map.width,
          "zoom-max": campaign.current_map.zoom_max,
          "css-vars": "x y viewport-x viewport-y width height zoom-amount"
        },
        style: "background-image: url('#{url_for campaign.current_map.image}');" do %>
        <div class="current-map__token-container" data-target="map.tokenContainer">
          <%= render campaign.current_map.tokens.where(stashed: false) %>
        </div>
        <% if dm?(campaign) %>
          <div class="controls w-16 absolute top-0 right-0 m-2 flex justify-center">
            <%= button_tag class: "current-map__zoom-out flex-1 text-center border rounded-l-md h-7 bg-gray-200 cursor-default", data: { target: "map.zoomOut", action: "click->map#zoomOut" } do %>
              -
            <% end %>
            <%= button_tag class: "current-map__zoom-in flex-1 text-center border rounded-r-md h-7 bg-gray-200 cursor-default", data: { target: "map.zoomIn", action: "click->map#zoomIn" } do %>
              +
            <% end %>
          </div>
        <% end %>
      <% end %>
    </div>
  <% end %>
<% else %>
  <h2>No Current Map</h2>
<% end %>
